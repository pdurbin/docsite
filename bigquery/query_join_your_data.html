<!DOCTYPE html>

<html lang="en">
<head>
  <title>Joining with External Data - Docs - Data Commons</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="icon" href="/assets/images/favicon.ico" type="image/x-icon"/>
  <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@600&family=Roboto&family=Material+Icons&display=swap" rel="stylesheet">
  <link href="/assets/css/styles.css" rel="stylesheet">
  <link rel="stylesheet" href="/assets/css/custom.css">
</head>
<body>
  <div id="main">
    <header id="main-header">
      <nav class="navbar navbar-dark navbar-expand-lg col" id="main-nav">
        <div class="container-fluid">
          <div class="navbar-brand">
            <a href="https://datacommons.org">Data Commons</a>
            <span><a href="/">Docs</a></span>
            </a>
          </div>
        <button class="navbar-toggler" type="button" data-toggle="collapse"
          data-target="#dc-main-nav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-md-end" id="dc-main-nav">
          <ul class="navbar-nav float-md-right">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="nav-explore-dropdown"
                role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                Explore
              </a>
              <div class="dropdown-menu" aria-labelledby="nav-explore-dropdown">
                <a class="dropdown-item" href="https://datacommons.org/place">Place
                  Explorer</a>
                <a class="dropdown-item" href="https://datacommons.org/browser">Graph
                  Browser</a>
                <a class="dropdown-item"
                  href="https://datacommons.org/tools/timeline">Timelines Explorer</a>
                <a class="dropdown-item"
                  href="https://datacommons.org/tools/scatter">Scatter Plot Explorer</a>
                <a class="dropdown-item"
                  href="https://datacommons.org/tools/map">Map Explorer</a>
                <a class="dropdown-item"
                  href="https://datacommons.org/tools/statvar">Statistical Variable Explorer</a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="nav-doc-dropdown"
                role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                Documentation
              </a>
              <div class="dropdown-menu" aria-labelledby="nav-doc-dropdown">
                <a class="dropdown-item" href="/">Documentation</a>
                <a class="dropdown-item" href="/api">APIs</a>
                <a class="dropdown-item" href="/tutorials">Tutorials</a>
                <a class="dropdown-item" href="/contributing/">Contribute</a>
              </div>
            </li>
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="nav-about-dropdown"
                role="button" data-toggle="dropdown" aria-haspopup="true"
                aria-expanded="false">
                About
              </a>
              <div class="dropdown-menu" aria-labelledby="nav-about-dropdown">
                <a class="dropdown-item" href="https://datacommons.org/about">About Data
                  Commons</a>
                <a class="dropdown-item" href="/blog.html">Blog</a>
                <a class="dropdown-item" href="https://datacommons.org/datasets">Data
                  Sources</a>
                <a class="dropdown-item" href="https://datacommons.org/faq">FAQ</a>
                <a class="dropdown-item" href="https://datacommons.org/feedback">Feedback</a>
              </div>
            </li>
            </ul>
            <div class="gcse-searchbox-only"
              data-resultsUrl="https://datacommons.org/search"></div>
            </div>
            </div>
      </nav>
    </header>

    <main id="" class="container-fluid">
      <div class="row">
        <div id="main-side-nav" class="col-3">
          <div id="sidebar"><details class="parent" open>
          <summary>
            <a href="/" class="">Why Data Commons</a>
            
          </summary>
          </details><details class="parent" open>
          <summary>
            <a href="/data_model.html" class="">Data Models</a>
            
          </summary>
          </details><details class="parent" open>
          <summary>
            <a href="/api/" class="">API</a>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path>
</svg>
          </summary>
          <ul id="node-22"><details class="child" >
                  <summary>
                    <a href="/api/python/" class="">Python</a>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path>
</svg>
                  </summary>
                  <ul id="child-1"><li class="">
                        <a href="/api/python/query.html" class="">SPARQL</a>
                      </li><li class="">
                        <a href="/api/python/triple.html" class="">Triple</a>
                      </li><li class="">
                        <a href="/api/python/property_label.html" class="">Property Label</a>
                      </li><li class="">
                        <a href="/api/python/property_value.html" class="">Property Value</a>
                      </li><li class="">
                        <a href="/api/python/place_in.html" class="">Places within a Place</a>
                      </li><li class="">
                        <a href="/api/python/stat_value.html" class="">Place Statistics - Single Value</a>
                      </li><li class="">
                        <a href="/api/python/stat_series.html" class="">Place Statistics - Time Series</a>
                      </li><li class="">
                        <a href="/api/python/stat_all.html" class="">Place Statistics - All</a>
                      </li></ul></details><details class="child" >
                  <summary>
                    <a href="/api/pandas/" class="">Pandas</a>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path>
</svg>
                  </summary>
                  <ul id="child-2"><li class="">
                        <a href="/api/pandas/time_series.html" class="">Time Series as pd.Series</a>
                      </li><li class="">
                        <a href="/api/pandas/time_series_dataframe.html" class="">Time Series Table as pd.DataFrame</a>
                      </li><li class="">
                        <a href="/api/pandas/multivariate_dataframe.html" class="">Multivariate Table as pd.DataFrame</a>
                      </li></ul></details><details class="child" >
                  <summary>
                    <a href="/api/rest/" class="">REST</a>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path>
</svg>
                  </summary>
                  <ul id="child-3"><li class="">
                        <a href="/api/rest/query.html" class="">SPARQL</a>
                      </li><li class="">
                        <a href="/api/rest/triple.html" class="">Triple</a>
                      </li><li class="">
                        <a href="/api/rest/property_label.html" class="">Property Label</a>
                      </li><li class="">
                        <a href="/api/rest/property_value.html" class="">Property Value</a>
                      </li><li class="">
                        <a href="/api/rest/place_in.html" class="">Places within a Place</a>
                      </li><li class="">
                        <a href="/api/rest/place_stat_vars.html" class="">Place Statistical Variables</a>
                      </li><li class="">
                        <a href="/api/rest/stat_value.html" class="">Place Statistics - Single Value</a>
                      </li><li class="">
                        <a href="/api/rest/stat_series.html" class="">Place Statistics - Time Series</a>
                      </li><li class="">
                        <a href="/api/rest/stat_all.html" class="">Place Statistics - All</a>
                      </li></ul></details><details class="child" >
                  <summary>
                    <a href="/api/sheets/" class="">Google Sheets</a>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path>
</svg>
                  </summary>
                  <ul id="child-4"><li class="">
                        <a href="/api/sheets/get_name.html" class="">Node Name</a>
                      </li><li class="">
                        <a href="/api/sheets/places_in.html" class="">Places within a Place</a>
                      </li><li class="">
                        <a href="/api/sheets/get_variable.html" class="">Statistical Variable Value</a>
                      </li><li class="">
                        <a href="/api/sheets/get_property.html" class="">Node Property</a>
                      </li><li class="">
                        <a href="/api/sheets/get_cohort_members.html" class="">Cohort Members</a>
                      </li><li class="">
                        <a href="/api/sheets/tutorials/" class="">Tutorials</a>
                      </li></ul></details></ul></details><details class="parent" open>
          <summary>
            <a href="/bigquery/" class="">BigQuery</a>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path>
</svg>
          </summary>
          <ul id="node-29"><details class="child" >
                  <summary>
                    <a href="/bigquery/data_in_bq.html" class="">What Data is in DC</a>
                    
                  </summary>
                  </details><details class="child" >
                  <summary>
                    <a href="/bigquery/unique_identifiers.html" class="">Unique Identifiers</a>
                    
                  </summary>
                  </details><details class="child" open>
                  <summary>
                    <a href="/bigquery/dc_to_bq_queries.html" class=" active">DC to BQ Sample Queries</a>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path>
</svg>
                  </summary>
                  <ul id="child-3"><li class="">
                        <a href="/bigquery/query_places.html" class="">Places</a>
                      </li><li class="">
                        <a href="/bigquery/query_property_places.html" class="">Properties of Places</a>
                      </li><li class="">
                        <a href="/bigquery/query_more_complex.html" class="">More Complex Queries</a>
                      </li><li class="active">
                        <a href="/bigquery/query_join_your_data.html" class=" active">Joining with External Data</a>
                      </li></ul></details></ul></details><details class="parent" open>
          <summary>
            <a href="/courseware/" class="">Courseware</a>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path>
</svg>
          </summary>
          <ul id="node-37"><details class="child" >
                  <summary>
                    <a href="/courseware/intro_data_science.html" class="">Intro to Data Science</a>
                    
                  </summary>
                  </details></ul></details><details class="parent" open>
          <summary>
            <a href="/tutorials/" class="">Case studies</a>
            
          </summary>
          </details><details class="parent" open>
          <summary>
            <a href="/csv_download.html" class="">CSV Bulk Download</a>
            
          </summary>
          </details><details class="parent" open>
          <summary>
            <a href="/contributing/" class="">Contributing to Data Commons</a>
            
          </summary>
          </details><details class="parent" open>
          <summary>
            <a href="/statistical_variables.html" class="">Statistical Variables</a>
            
          </summary>
          </details><details class="parent" open>
          <summary>
            <a href="/glossary.html" class="">Glossary</a>
            
          </summary>
          </details><details class="parent" open>
          <summary>
            <a href="/datasets/" class="">Data Sources</a>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="14" height="14">
  <path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path>
</svg>
          </summary>
          <ul id="node-57"><details class="child" >
                  <summary>
                    <a href="/datasets/Agriculture.html" class="">Agriculture</a>
                    
                  </summary>
                  </details><details class="child" >
                  <summary>
                    <a href="/datasets/Biomedical.html" class="">Biomedical</a>
                    
                  </summary>
                  </details><details class="child" >
                  <summary>
                    <a href="/datasets/Crime.html" class="">Crime</a>
                    
                  </summary>
                  </details><details class="child" >
                  <summary>
                    <a href="/datasets/Demographics.html" class="">Demographics</a>
                    
                  </summary>
                  </details><details class="child" >
                  <summary>
                    <a href="/datasets/Economy.html" class="">Economy</a>
                    
                  </summary>
                  </details><details class="child" >
                  <summary>
                    <a href="/datasets/Education.html" class="">Education</a>
                    
                  </summary>
                  </details><details class="child" >
                  <summary>
                    <a href="/datasets/Energy.html" class="">Energy</a>
                    
                  </summary>
                  </details><details class="child" >
                  <summary>
                    <a href="/datasets/Environment.html" class="">Environment</a>
                    
                  </summary>
                  </details><details class="child" >
                  <summary>
                    <a href="/datasets/Health.html" class="">Health</a>
                    
                  </summary>
                  </details><details class="child" >
                  <summary>
                    <a href="/datasets/Housing.html" class="">Housing</a>
                    
                  </summary>
                  </details><details class="child" >
                  <summary>
                    <a href="/datasets/upcoming.html" class="">Upcoming Data Imports</a>
                    
                  </summary>
                  </details></ul></details><details class="parent" open>
          <summary>
            <a href="/blog.html" class="">Blog</a>
            
          </summary>
          </details></div>
        </div>
        <div class="col-9">
          <div id="main-doc-content">
            
              
                <nav aria-label="Breadcrumb" id="main-breadcrumb">
                  <ol class="breadcrumb">
                    
                      <li class="breadcrumb-item">
                        <a href="/bigquery/">
                          BigQuery
                        </a>
                      </li>
                      <li class="breadcrumb-item">
                        <a href="/bigquery/dc_to_bq_queries.html">
                          DC to BQ Sample Queries
                        </a>
                      </li>
                    
                    <li class="breadcrumb-item active"><span>Joining with External Data</span></li>
                  </ol>
                </nav>
              
            
            <h1 id="query-category-joining-with-data-outside-data-commons">Query Category: Joining with Data outside Data Commons</h1>

<p>This page illustrates how you can join external datasets with Data Commons by relying on unique IDs and geo locations.  For the examples below, we use other public datasets in BigQuery Analytics Hub, but they can be any other private/public dataset.</p>

<h3 id="using-fips-codes">Using <a href="https://www.census.gov/library/reference/code-lists/ansi.html">FIPS</a> codes</h3>

<p>We use the <a href="https://console.cloud.google.com/bigquery/analytics-hub/exchanges(analyticshub:projects/1057666841514/locations/us/dataExchanges/google_cloud_public_datasets_17e74966199/listings/nhtsa_traffic_fatalities_17f892354f9)">Fatal Accidents dataset from National Highway Traffic Safety Administration</a> to compute counties with highest fatal accidents per capita. We map to DC counties using the FIPS or geoId, and use total population statistics. Loving County, TX (the least populated county in main US) and Kenedy County, TX are at the top.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">FatalAccidents</span> <span class="k">AS</span> <span class="p">(</span>
<span class="k">SELECT</span>
  <span class="n">CONCAT</span><span class="p">(</span><span class="n">LPAD</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="n">NHTSA</span><span class="p">.</span><span class="n">state_number</span> <span class="k">AS</span> <span class="n">STRING</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">),</span> <span class="n">LPAD</span><span class="p">(</span><span class="k">CAST</span><span class="p">(</span><span class="n">NHTSA</span><span class="p">.</span><span class="n">county</span> <span class="k">AS</span> <span class="n">STRING</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'0'</span><span class="p">))</span> <span class="k">AS</span> <span class="n">FIPS</span><span class="p">,</span>
  <span class="k">COUNT</span><span class="p">(</span><span class="n">consecutive_number</span><span class="p">)</span> <span class="k">AS</span> <span class="k">Count</span>
<span class="k">FROM</span> <span class="nv">`nhtsa_traffic_fatalities.accident_2016`</span> <span class="k">AS</span> <span class="n">NHTSA</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">FIPS</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">P</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">CountyId</span><span class="p">,</span>
       <span class="n">P</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">CountyName</span><span class="p">,</span>
       <span class="n">IF</span><span class="p">(</span><span class="n">Obs</span><span class="p">.</span><span class="n">value</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span> <span class="n">FA</span><span class="p">.</span><span class="k">Count</span> <span class="o">/</span> <span class="k">CAST</span><span class="p">(</span><span class="n">Obs</span><span class="p">.</span><span class="n">value</span> <span class="k">AS</span> <span class="n">FLOAT64</span><span class="p">),</span> <span class="k">NULL</span><span class="p">)</span> <span class="k">AS</span> <span class="n">FatalAccidentsPerCapita</span>
<span class="k">FROM</span> <span class="n">FatalAccidents</span> <span class="k">AS</span> <span class="n">FA</span>
<span class="k">JOIN</span> <span class="nv">`data_commons.Observation`</span> <span class="k">AS</span> <span class="n">Obs</span> <span class="k">ON</span> <span class="k">TRUE</span>
<span class="k">JOIN</span> <span class="nv">`data_commons.Place`</span> <span class="k">AS</span> <span class="n">P</span> <span class="k">ON</span> <span class="k">TRUE</span>
<span class="k">WHERE</span>
  <span class="n">P</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">Obs</span><span class="p">.</span><span class="n">observation_about</span> <span class="k">AND</span>
  <span class="n">P</span><span class="p">.</span><span class="n">geo_id</span> <span class="o">=</span> <span class="n">FA</span><span class="p">.</span><span class="n">FIPS</span> <span class="k">AND</span>
  <span class="n">Obs</span><span class="p">.</span><span class="n">variable_measured</span> <span class="o">=</span> <span class="s1">'Count_Person'</span> <span class="k">AND</span>
  <span class="n">Obs</span><span class="p">.</span><span class="n">is_preferred_obs_across_facets</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">FatalAccidentsPerCapita</span> <span class="k">DESC</span>
</code></pre></div></div>

<h3 id="using-zip-codes">Using Zip codes</h3>

<p>We use Google’s <a href="https://console.cloud.google.com/bigquery/analytics-hub/exchanges(analyticshub:projects/1057666841514/locations/us/dataExchanges/google_cloud_public_datasets_17e74966199/listings/d29ba6d0d3a64b6284d0fe57eedc9355)">Project SunRoof</a> dataset to compute solar potential for low-income Zip code areas in the US.  From 500 Zip code areas with the lowest median income, we compute those Zip codes that have the highest solar potential (among those that were sufficiently qualified). Of the 500, we find that 133 of them had &gt; 50% potential.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">LowestEarnerZips</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">Obs</span><span class="p">.</span><span class="n">observation_about</span> <span class="k">AS</span> <span class="n">PlaceId</span><span class="p">,</span>
           <span class="n">Obs</span><span class="p">.</span><span class="n">Value</span> <span class="k">AS</span> <span class="n">Income</span>
    <span class="k">FROM</span> <span class="nv">`data_commons.Observation`</span> <span class="k">AS</span> <span class="n">Obs</span>
    <span class="k">WHERE</span>
        <span class="n">Obs</span><span class="p">.</span><span class="n">is_preferred_obs_across_facets</span> <span class="k">AND</span>
        <span class="n">Obs</span><span class="p">.</span><span class="n">variable_measured</span> <span class="o">=</span> <span class="s1">'Median_Income_Person'</span> <span class="k">AND</span>
        <span class="n">Obs</span><span class="p">.</span><span class="n">observation_about</span> <span class="k">LIKE</span> <span class="s1">'zip/%'</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="k">CAST</span><span class="p">(</span><span class="n">Value</span> <span class="k">AS</span> <span class="n">FLOAT64</span><span class="p">)</span>
    <span class="k">LIMIT</span> <span class="mi">500</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">SunRoof</span><span class="p">.</span><span class="n">region_name</span> <span class="k">AS</span> <span class="n">Zip</span><span class="p">,</span> <span class="n">SunRoof</span><span class="p">.</span><span class="n">state_name</span> <span class="k">AS</span> <span class="k">State</span><span class="p">,</span> <span class="n">SunRoof</span><span class="p">.</span><span class="n">percent_qualified</span> <span class="k">AS</span> <span class="n">PercentSunRoof</span>
<span class="k">FROM</span> <span class="n">LowestEarnerZips</span> <span class="k">AS</span> <span class="n">DC</span>
<span class="k">JOIN</span> <span class="nv">`project_sunroof.solar_potential_by_postal_code`</span> <span class="k">AS</span> <span class="n">SunRoof</span> <span class="k">ON</span> <span class="k">TRUE</span>
<span class="k">WHERE</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">'zip/'</span><span class="p">,</span> <span class="n">SunRoof</span><span class="p">.</span><span class="n">region_name</span><span class="p">)</span> <span class="o">=</span> <span class="n">DC</span><span class="p">.</span><span class="n">PlaceId</span> <span class="k">AND</span>
      <span class="n">SunRoof</span><span class="p">.</span><span class="n">percent_qualified</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">AND</span>
      <span class="n">SunRoof</span><span class="p">.</span><span class="n">percent_covered</span> <span class="o">&gt;</span> <span class="mi">80</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">PercentSunRoof</span> <span class="k">DESC</span>
</code></pre></div></div>

<h3 id="latitudelongitude-based-join">Latitude/Longitude based join</h3>

<p>From the <a href="https://console.cloud.google.com/bigquery/analytics-hub/exchanges(analyticshub:projects/1057666841514/locations/us/dataExchanges/google_cloud_public_datasets_17e74966199/listings/openstreetmap_public_dataset_17f8979a16c)">OpenStreetMap Public Dataset</a>, we compute the US counties with most fire-hydrants per unit area.  To do this, we use the geo boundaries in DC to map latitude/longitude to US counties and get their corresponding land area values.  Alexandria County, Virginia is at the top of the list.</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">WITH</span> <span class="n">CountyFireHydrantCount</span> <span class="k">AS</span><span class="p">(</span>
  <span class="k">WITH</span> <span class="n">FireHydrantLocations</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">geometry</span> <span class="k">AS</span> <span class="n">Geo</span>
    <span class="k">FROM</span>  <span class="nv">`openstreetmap_public_dataset.planet_nodes`</span> <span class="k">AS</span> <span class="n">node</span>
    <span class="k">JOIN</span> <span class="k">UNNEST</span><span class="p">(</span><span class="n">all_tags</span><span class="p">)</span> <span class="k">AS</span> <span class="n">tags</span>
    <span class="k">WHERE</span> <span class="p">(</span><span class="n">tags</span><span class="p">.</span><span class="k">key</span> <span class="o">=</span> <span class="s1">'emergency'</span> <span class="k">AND</span> <span class="n">tags</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="s1">'fire_hydrant'</span><span class="p">))</span>
  <span class="k">SELECT</span> <span class="n">PB</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">CountyId</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">NumHydrants</span>
  <span class="k">FROM</span> <span class="nv">`data_commons.PlaceBoundary`</span> <span class="k">AS</span> <span class="n">PB</span>
  <span class="k">JOIN</span> <span class="nv">`data_commons.Place`</span> <span class="k">AS</span> <span class="n">P</span> <span class="k">ON</span> <span class="k">TRUE</span>
  <span class="k">JOIN</span> <span class="n">FireHydrantLocations</span> <span class="k">ON</span> <span class="k">TRUE</span>
  <span class="k">WHERE</span>
    <span class="n">P</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">PB</span><span class="p">.</span><span class="n">id</span> <span class="k">AND</span>
    <span class="k">EXISTS</span><span class="p">(</span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="k">UNNEST</span><span class="p">(</span><span class="n">P</span><span class="p">.</span><span class="n">all_types</span><span class="p">)</span> <span class="k">AS</span> <span class="n">T</span> <span class="k">WHERE</span> <span class="n">T</span> <span class="o">=</span> <span class="s1">'County'</span><span class="p">)</span> <span class="k">AND</span>
    <span class="n">ST_WITHIN</span><span class="p">(</span><span class="n">FireHydrantLocations</span><span class="p">.</span><span class="n">Geo</span><span class="p">,</span>
              <span class="n">ST_GEOGFROMGEOJSON</span><span class="p">(</span><span class="n">PB</span><span class="p">.</span><span class="n">geo_json_coordinates</span><span class="p">,</span> <span class="n">make_valid</span> <span class="o">=&gt;</span> <span class="k">TRUE</span><span class="p">))</span>
  <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">CountyId</span><span class="p">)</span>
<span class="k">SELECT</span> <span class="n">P</span><span class="p">.</span><span class="n">id</span> <span class="k">AS</span> <span class="n">CountyId</span><span class="p">,</span>
       <span class="n">P</span><span class="p">.</span><span class="n">name</span> <span class="k">AS</span> <span class="n">CountyName</span><span class="p">,</span>
       <span class="n">CountyFireHydrantCount</span><span class="p">.</span><span class="n">NumHydrants</span> <span class="o">/</span>
             <span class="p">(</span><span class="n">SUBSTR</span><span class="p">(</span><span class="n">P</span><span class="p">.</span><span class="n">land_Area</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="k">AS</span> <span class="n">INT64</span><span class="p">)</span> <span class="k">AS</span> <span class="n">HydrantsPerSqMeter</span>
<span class="k">FROM</span> <span class="nv">`data_commons.Place`</span> <span class="k">AS</span> <span class="n">P</span>
<span class="k">JOIN</span> <span class="n">CountyFireHydrantCount</span> <span class="k">ON</span> <span class="k">TRUE</span>
<span class="k">WHERE</span>
  <span class="n">P</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">CountyFireHydrantCount</span><span class="p">.</span><span class="n">CountyId</span> <span class="k">AND</span>
  <span class="n">STARTS_WITH</span><span class="p">(</span><span class="n">P</span><span class="p">.</span><span class="n">land_area</span><span class="p">,</span> <span class="s1">'SquareMeter'</span><span class="p">)</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">HydrantsPerSqMeter</span> <span class="k">DESC</span>
</code></pre></div></div>

          </div>
        </div>
      </div>
    </main>

    <footer id="main-footer">
      <div class="container">
        <div class="row">
          <div id="sub-footer" class="col-12">
            <span><a href="https://datacommons.org">Data Commons</a> is a Google supported project</span>
            <div class="float-md-right mt-2 mt-md-0">
              <a href="https://policies.google.com/terms">Terms and Conditions</a> ·
              <a href="https://policies.google.com/privacy?hl=en-US">Privacy Policy</a> ·
              <a href="https://datacommons.org/disclaimers">Disclaimers</a>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>
  <script
    src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script
    src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <script async
    src="https://cse.google.com/cse.js?cx=010079880385165835740%3Aosnv3q-sw08"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-117119267-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'UA-117119267-1');
  </script>
  <script src="/assets/js/tabs.js"></script>
</body>
</html>
